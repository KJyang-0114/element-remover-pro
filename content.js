class ElementManager {
  constructor() {
    this.isActive = false;
    this.currentMode = 'single';
    this.selectedElements = new Set();
    this.removedElements = new Map();
    this.redoStack = new Map();
    this.savedRules = new Map();
    
    // ÊîØÊè¥ÁöÑË™ûË®ÄÂàóË°®
    this.supportedLanguages = {
      'en': 'English',
      'zh': '‰∏≠Êñá',
      'ja': 'Êó•Êú¨Ë™û',
      'ko': 'ÌïúÍµ≠Ïñ¥',
      'ru': '–†—É—Å—Å–∫–∏–π',
      'es': 'Espa√±ol'
    };
    
    // Â§öË™ûË®ÄÊîØÊè¥
    this.currentLang = this.loadLanguagePreference() || navigator.language.toLowerCase().split('-')[0] || 'en';
    this.i18n = null;  // ÂàùÂßãÂåñÁÇ∫ null
    
    // Ë®≠ÂÆö
    this.settings = {
      autoHide: false,
      smartSelect: false,
      language: this.currentLang
    };
    
    this.floatingMenu = null;
    this.isMenuVisible = false;
  }

  async init() {
    await this.loadLanguages();
    this.setupEventListeners();
  }

  async loadLanguages() {
    try {
      const response = await fetch(chrome.runtime.getURL('languages.json'));
      this.i18n = await response.json();
      console.log('Languages loaded:', this.i18n);  // Ê∑ªÂä†Êó•Ë™å
    } catch (error) {
      console.error('Error loading languages:', error);
      // Â¶ÇÊûúÂä†ËºâÂ§±ÊïóÔºå‰ΩøÁî®È†êË®≠ÁöÑËã±Êñá
      this.currentLang = 'en';
      this.i18n = {
        en: {
          menuTitle: "Element Remover Pro",
          // ... ÂÖ∂‰ªñÈ†êË®≠Ëã±ÊñáÁøªË≠Ø
        }
      };
    }
  }

  loadLanguagePreference() {
    const lang = localStorage.getItem('elementRemoverLanguage');
    return lang && this.supportedLanguages[lang] ? lang : null;
  }

  saveLanguagePreference(lang) {
    localStorage.setItem('elementRemoverLanguage', lang);
    this.currentLang = lang;
    this.settings.language = lang;
    this.saveSettings();
    this.updateMenuLanguage();
  }

  updateMenuLanguage() {
    if (!this.floatingMenu) return;
    
    // Êõ¥Êñ∞ÊâÄÊúâÊñáÊú¨ÂÖßÂÆπ
    this.floatingMenu.querySelector('.title').textContent = this.getText('title');
    this.floatingMenu.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.dataset.i18n;
      element.textContent = this.getText(key);
    });
  }

  createFloatingMenu() {
    const menu = document.createElement('div');
    menu.className = 'element-remover-menu';
    menu.style.position = 'fixed';
    menu.style.left = '20px';
    menu.style.top = '20px';
    
    // Ê®ôÈ°åÂçÄÂüü
    const header = document.createElement('div');
    header.className = 'element-remover-header';
    header.textContent = this.getText('menuTitle');
    
    const headerActions = document.createElement('div');
    headerActions.className = 'header-actions';
    
    const minimizeBtn = document.createElement('button');
    minimizeBtn.textContent = '‚àí';
    minimizeBtn.title = this.getText('minimize');
    minimizeBtn.onclick = () => this.toggleMenuMinimize();
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.textContent = '√ó';
    closeBtn.title = this.getText('close');
    closeBtn.onclick = () => {
      this.deactivate();
      this.hideMenu();
    };
    
    headerActions.appendChild(minimizeBtn);
    headerActions.appendChild(closeBtn);
    header.appendChild(headerActions);
    
    const content = document.createElement('div');
    content.className = 'element-remover-content';
    
    // ÁµêÊùüÂà™Èô§ÊåâÈàï
    const stopSection = document.createElement('div');
    stopSection.className = 'stop-section';
    
    const stopButton = document.createElement('button');
    stopButton.className = 'stop-btn danger';
    stopButton.innerHTML = '‚èπÔ∏è ' + this.getText('stopRemoving');
    stopButton.onclick = () => {
      this.deactivate();
      this.hideMenu();
      this.showNotification('notifications.removingStopped');
    };
    
    stopSection.appendChild(stopButton);
    content.appendChild(stopSection);
    
    // Ê®°ÂºèÈÅ∏ÊìáÂçÄÊÆµ
    const modeSection = document.createElement('div');
    modeSection.className = 'mode-section';
    
    const modeTitle = document.createElement('h3');
    modeTitle.textContent = this.getText('selectMode');
    modeSection.appendChild(modeTitle);
    
    const modeButtons = document.createElement('div');
    modeButtons.className = 'mode-buttons';
    
    const modes = [
      { id: 'single', icon: 'üéØ', label: this.getText('singleMode') },
      { id: 'multi', icon: '‚ú®', label: this.getText('multiMode') },
      { id: 'similar', icon: 'üîç', label: this.getText('similarMode') }
    ];
    
    modes.forEach(mode => {
      const button = document.createElement('button');
      button.className = 'mode-btn';
      if (mode.id === this.currentMode) {
        button.classList.add('active');
      }
      button.dataset.mode = mode.id;
      button.innerHTML = `${mode.icon} ${mode.label}`;
      button.onclick = () => this.setMode(mode.id);
      modeButtons.appendChild(button);
    });
    
    modeSection.appendChild(modeButtons);
    content.appendChild(modeSection);
    
    // Ë¶èÂâáË®≠ÁΩÆÂçÄÊÆµ
    const rulesSection = document.createElement('div');
    rulesSection.className = 'rules-section';
    
    const rulesTitle = document.createElement('h3');
    rulesTitle.textContent = this.getText('rules');
    rulesSection.appendChild(rulesTitle);
    
    const autoHideLabel = document.createElement('label');
    autoHideLabel.className = 'switch-label';
    autoHideLabel.innerHTML = `
      <input type="checkbox" id="autoHide">
      <span>${this.getText('autoHide')}</span>
    `;
    
    const smartSelectLabel = document.createElement('label');
    smartSelectLabel.className = 'switch-label';
    smartSelectLabel.innerHTML = `
      <input type="checkbox" id="smartSelect">
      <span>${this.getText('smartSelect')}</span>
    `;
    
    rulesSection.appendChild(autoHideLabel);
    rulesSection.appendChild(smartSelectLabel);
    content.appendChild(rulesSection);
    
    // Ê≠∑Âè≤Ë®òÈåÑÂçÄÊÆµ
    const historySection = document.createElement('div');
    historySection.className = 'history-section';
    
    const historyTitle = document.createElement('h3');
    historyTitle.textContent = this.getText('history');
    historySection.appendChild(historyTitle);
    
    const historyActions = document.createElement('div');
    historyActions.className = 'history-actions';
    
    const undoBtn = document.createElement('button');
    undoBtn.className = 'history-btn';
    undoBtn.innerHTML = '‚Ü©Ô∏è ' + this.getText('undo');
    undoBtn.onclick = () => this.undo();
    
    const redoBtn = document.createElement('button');
    redoBtn.className = 'history-btn';
    redoBtn.innerHTML = '‚Ü™Ô∏è ' + this.getText('redo');
    redoBtn.onclick = () => this.redo();
    
    historyActions.appendChild(undoBtn);
    historyActions.appendChild(redoBtn);
    historySection.appendChild(historyActions);
    content.appendChild(historySection);
    
    // Ë™ûË®ÄË®≠ÁΩÆÂçÄÊÆµ
    const languageSection = document.createElement('div');
    languageSection.className = 'language-section';
    
    const languageTitle = document.createElement('h3');
    languageTitle.textContent = this.getText('languageSettings');
    languageSection.appendChild(languageTitle);
    
    const languageSelect = document.createElement('select');
    languageSelect.className = 'language-select';
    
    Object.entries(this.supportedLanguages).forEach(([code, name]) => {
      const option = document.createElement('option');
      option.value = code;
      option.textContent = name;
      if (code === this.currentLang) {
        option.selected = true;
      }
      languageSelect.appendChild(option);
    });
    
    languageSelect.onchange = (e) => {
      this.saveLanguagePreference(e.target.value);
      this.updateMenuText();
    };
    
    languageSection.appendChild(languageSelect);
    content.appendChild(languageSection);
    
    menu.appendChild(header);
    menu.appendChild(content);
    document.body.appendChild(menu);
    
    // ‰øÆÊ≠£ÊãñÊõ≥ÂäüËÉΩ
    this.makeDraggable(menu);
    this.setupMenuListeners();
    
    return menu;
  }

  makeDraggable(menu) {
    const header = menu.querySelector('.element-remover-header');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;
    let xOffset = 0;
    let yOffset = 0;

    const dragStart = (e) => {
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;

      if (e.target === header) {
        isDragging = true;
      }
    };

    const dragEnd = () => {
      isDragging = false;
    };

    const drag = (e) => {
      if (isDragging) {
        e.preventDefault();
        
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;

        xOffset = currentX;
        yOffset = currentY;

        menu.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
      }
    };

    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
  }

  setupMenuListeners() {
    const menu = this.floatingMenu;
    if (!menu) return;

    // Ê®°ÂºèÈÅ∏ÊìáÊåâÈàï
    menu.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        menu.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        this.setMode(btn.dataset.mode);
      });
    });

    // Ë¶èÂâáË®≠ÂÆö
    const autoHideCheckbox = menu.querySelector('#autoHide');
    if (autoHideCheckbox) {
      autoHideCheckbox.checked = this.settings.autoHide;
      autoHideCheckbox.addEventListener('change', (e) => {
        this.settings.autoHide = e.target.checked;
        this.saveSettings();
      });
    }

    const smartSelectCheckbox = menu.querySelector('#smartSelect');
    if (smartSelectCheckbox) {
      smartSelectCheckbox.checked = this.settings.smartSelect;
      smartSelectCheckbox.addEventListener('change', (e) => {
        this.settings.smartSelect = e.target.checked;
        this.saveSettings();
      });
    }

    // Ê≠∑Âè≤Êìç‰ΩúÊåâÈàï
    const undoBtn = menu.querySelector('.history-actions button:first-child');
    if (undoBtn) {
      undoBtn.addEventListener('click', () => this.undo());
    }

    const redoBtn = menu.querySelector('.history-actions button:last-child');
    if (redoBtn) {
      redoBtn.addEventListener('click', () => this.redo());
    }

    // Ë™ûË®ÄÈÅ∏Êìá
    const languageSelect = menu.querySelector('.language-select');
    if (languageSelect) {
      languageSelect.value = this.currentLang;
      languageSelect.addEventListener('change', (e) => {
        this.saveLanguagePreference(e.target.value);
      });
    }

    // ÂÅúÊ≠¢ÊåâÈàï
    const stopBtn = menu.querySelector('.stop-btn');
    if (stopBtn) {
      stopBtn.addEventListener('click', () => {
        this.deactivate();
        this.hideMenu();
        this.showNotification('notifications.removingStopped');
      });
    }
  }

  showMenu() {
    if (!this.floatingMenu) {
      this.floatingMenu = this.createFloatingMenu();
    }
    this.floatingMenu.style.display = 'block';
    this.isMenuVisible = true;
  }

  hideMenu() {
    if (this.floatingMenu) {
      this.floatingMenu.style.display = 'none';
      this.isMenuVisible = false;
    }
  }

  saveSettings() {
    chrome.storage.local.set({
      settings: this.settings
    });
  }

  loadSettings() {
    chrome.storage.local.get(['settings'], (result) => {
      if (result.settings) {
        this.settings = { ...this.settings, ...result.settings };
      }
    });
  }

  saveCurrentRules() {
    const rules = Array.from(this.removedElements.values()).map(info => ({
      selector: this.getElementSelector(info.element),
      type: info.element.tagName.toLowerCase(),
      path: this.getElementPath(info.element)
    }));

    chrome.storage.local.get(['siteRules'], (result) => {
      const allRules = result.siteRules || {};
      allRules[this.currentDomain] = rules;
      chrome.storage.local.set({ siteRules: allRules });
      this.showNotification('Ë¶èÂâáÂ∑≤‰øùÂ≠ò');
    });
  }

  clearSiteRules() {
    chrome.storage.local.get(['siteRules'], (result) => {
      const allRules = result.siteRules || {};
      delete allRules[this.currentDomain];
      chrome.storage.local.set({ siteRules: allRules });
      this.showNotification('Á∂≤Á´ôË¶èÂâáÂ∑≤Ê∏ÖÈô§');
    });
  }

  loadSavedRules() {
    chrome.storage.local.get(['siteRules'], (result) => {
      const rules = result.siteRules?.[this.currentDomain] || [];
      this.savedRules.set(this.currentDomain, rules);
    });
  }

  applyRules() {
    const rules = this.savedRules.get(this.currentDomain) || [];
    rules.forEach(rule => {
      const elements = document.querySelectorAll(rule.selector);
      elements.forEach(element => {
        if (this.isValidTarget(element)) {
          this.removeElements([element]);
        }
      });
    });
  }

  resetPage() {
    Array.from(this.removedElements.values()).forEach(info => {
      if (info.nextSibling) {
        info.parent.insertBefore(info.element, info.nextSibling);
      } else {
        info.parent.appendChild(info.element);
      }
    });
    this.removedElements.clear();
    this.showNotification('È†ÅÈù¢Â∑≤ÈáçË®≠');
  }

  showNotification(messageKey, params = {}) {
    try {
      const message = this.getText(messageKey, params);
      
      // ÁßªÈô§ËàäÁöÑÈÄöÁü•
      const oldNotification = document.querySelector('.element-remover-notification');
      if (oldNotification) {
        oldNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = 'element-remover-notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // 2ÁßíÂæåËá™ÂãïÁßªÈô§
      setTimeout(() => {
        if (notification && notification.parentNode) {
          notification.remove();
        }
      }, 2000);
    } catch (error) {
      console.error('Error showing notification:', error);
    }
  }

  setupDraggable(menu) {
    const header = menu.querySelector('.element-remover-header');
    let isDragging = false;
    let currentX;
    let currentY;
    let initialX;
    let initialY;

    header.addEventListener('mousedown', (e) => {
      isDragging = true;
      initialX = e.clientX - menu.offsetLeft;
      initialY = e.clientY - menu.offsetTop;
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      e.preventDefault();
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;

      menu.style.left = `${currentX}px`;
      menu.style.top = `${currentY}px`;
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });
  }

  setupEventListeners() {
    // ÊªëÈº†ÁßªÂãï‰∫ã‰ª∂
    document.addEventListener('mousemove', this.handleMouseMove.bind(this));
    // ÈªûÊìä‰∫ã‰ª∂
    document.addEventListener('click', this.handleClick.bind(this));
    // ÊåâÈçµ‰∫ã‰ª∂
    document.addEventListener('keydown', this.handleKeyDown.bind(this));
  }

  handleMouseMove(e) {
    if (!this.isActive) return;
    
    const target = e.target;

    // ‰∏çËôïÁêÜÈÅ∏ÂñÆÁõ∏ÈóúÂÖÉÁ¥†
    if (this.floatingMenu && (this.floatingMenu === target || this.floatingMenu.contains(target))) {
      this.clearHighlight();
      return;
    }

    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂèØÂà™Èô§ÁöÑÂÖÉÁ¥†
    if (!this.isValidTarget(target)) {
      this.clearHighlight();
      return;
    }

    // ÁßªÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
    this.clearHighlight();

    if (this.currentMode === 'similar') {
      // Â∞ãÊâæÁõ∏‰ººÂÖÉÁ¥†
      const similarElements = this.findSimilarElements(target);
      similarElements.forEach(element => {
        this.highlightElement(element);
      });
    } else {
      // ÂñÆ‰∏ÄÊàñÂ§öÈáçÈÅ∏ÊìáÊ®°Âºè
      this.highlightElement(target);
    }
  }

  handleClick(e) {
    if (!this.isActive) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const target = e.target;
    
    // Ê™¢Êü•ÊòØÂê¶ÈªûÊìäÂà∞ÈÅ∏ÂñÆÊàñÂÖ∂Â≠êÂÖÉÁ¥†
    if (this.floatingMenu && (this.floatingMenu === target || this.floatingMenu.contains(target))) {
      return;
    }

    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂèØÂà™Èô§ÁöÑÂÖÉÁ¥†
    if (!this.isValidTarget(target)) {
      return;
    }
    
    try {
      if (this.currentMode === 'multi') {
        if (e.shiftKey) {
          // Shift + ÈªûÊìä = Âà™Èô§ÊâÄÊúâÈÅ∏‰∏≠ÁöÑÂÖÉÁ¥†
          const elements = Array.from(this.selectedElements);
          if (elements.length > 0) {
            this.removeElements(elements);
            this.selectedElements.clear();
          }
        } else {
          // ‰∏ÄËà¨ÈªûÊìä = ÈÅ∏ÊìáÂÖÉÁ¥†
          this.toggleElementSelection(target);
          // Áï∂ÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÂÖÉÁ¥†ÊôÇÈ°ØÁ§∫ÊèêÁ§∫
          if (this.selectedElements.size === 1) {
            setTimeout(() => {
              this.showNotification('notifications.shiftClickTip');
            }, 500);
          }
        }
      } else if (this.currentMode === 'similar') {
        const similarElements = this.findSimilarElements(target);
        if (similarElements.length > 0) {
          this.removeElements(similarElements);
        }
      } else {
        // ÂñÆ‰∏ÄÊ®°Âºè
        this.removeElements([target]);
      }
    } catch (error) {
      console.error('Error handling click:', error);
    }
  }

  handleKeyDown(e) {
    if (!this.isActive) return;
    
    if (e.key === 'Escape') {
      this.deactivate();
    } else if (e.key === 'z' && e.ctrlKey) {
      this.undo();
    } else if (e.key === 'y' && e.ctrlKey) {
      this.redo();
    }
  }

  toggleElementSelection(element) {
    if (!this.isValidTarget(element)) return;

    if (this.selectedElements.has(element)) {
      this.selectedElements.delete(element);
      element.classList.remove('element-remover-selected');
    } else {
      this.selectedElements.add(element);
      element.classList.add('element-remover-selected');
    }

    // Êõ¥Êñ∞ÈÅ∏‰∏≠Êï∏ÈáèÊèêÁ§∫
    const count = this.selectedElements.size;
    if (count > 0) {
      this.showNotification('selectedCount', { count });
    }
  }

  removeElements(elements) {
    try {
      const validElements = elements.filter(element => this.isValidTarget(element));
      
      if (validElements.length === 0) {
        return;
      }
      
      validElements.forEach(element => {
        // ‰øùÂ≠òÂÖÉÁ¥†ÁöÑÂéüÂßãÁãÄÊÖã
        const elementInfo = {
          element: element,
          parent: element.parentNode,
          nextSibling: element.nextSibling,
          html: element.outerHTML
        };
        
        // Âæû DOM ‰∏≠ÁßªÈô§ÂÖÉÁ¥†
        if (element.parentNode) {
          element.parentNode.removeChild(element);
          
          // Â∞áÂÖÉÁ¥†Ê∑ªÂä†Âà∞Â∑≤ÁßªÈô§ÂàóË°®
          this.removedElements.set(element, elementInfo);
          
          // Ê∏ÖÈô§ÈÅ∏‰∏≠ÁãÄÊÖã
          this.selectedElements.delete(element);
        }
      });
      
      // È°ØÁ§∫ÈÄöÁü•
      if (validElements.length === 1) {
        this.showNotification('elementRemoved');
      } else {
        this.showNotification('elementsRemoved', { count: validElements.length });
      }
      
      // Ê∏ÖÈô§È´ò‰∫Æ
      this.clearHighlight();
      
    } catch (error) {
      console.error('Error removing elements:', error);
    }
  }

  undo() {
    try {
      const entries = Array.from(this.removedElements.entries());
      const lastEntry = entries.pop();
      
      if (!lastEntry) {
        this.showNotification('noMoreUndo');
        return;
      }
      
      const [element, info] = lastEntry;
      
      // ÊÅ¢Âæ©ÂÖÉÁ¥†
      if (info.nextSibling) {
        info.parent.insertBefore(info.element, info.nextSibling);
      } else {
        info.parent.appendChild(info.element);
      }
      
      // ÂæûÁßªÈô§ÂàóË°®‰∏≠Âà™Èô§
      this.removedElements.delete(element);
      
      // Ê∑ªÂä†Âà∞ÈáçÂÅöÂ†ÜÁñä
      this.redoStack.set(element, info);
      
      this.showNotification('undoSuccess');
    } catch (error) {
      console.error('Error undoing:', error);
    }
  }

  redo() {
    try {
      const entries = Array.from(this.redoStack.entries());
      const lastEntry = entries.pop();
      
      if (!lastEntry) {
        this.showNotification('noMoreRedo');
        return;
      }
      
      const [element, info] = lastEntry;
      
      // ÈáçÊñ∞ÁßªÈô§ÂÖÉÁ¥†
      if (element.parentNode) {
        element.parentNode.removeChild(element);
      }
      
      // ÂæûÈáçÂÅöÂ†ÜÁñä‰∏≠Âà™Èô§
      this.redoStack.delete(element);
      
      // Ê∑ªÂä†ÂõûÁßªÈô§ÂàóË°®
      this.removedElements.set(element, info);
      
      this.showNotification('redoSuccess');
    } catch (error) {
      console.error('Error redoing:', error);
    }
  }

  findSimilarElements(element) {
    const similarElements = [];
    const tagName = element.tagName;
    const className = element.className;
    
    // Âü∫Êú¨Áõ∏‰ººÊÄßÂà§Êñ∑
    const selector = className ? 
      `${tagName.toLowerCase()}.${className.split(' ').join('.')}` :
      tagName.toLowerCase();
    
    document.querySelectorAll(selector).forEach(el => {
      if (this.isSimilar(element, el)) {
        similarElements.push(el);
      }
    });
    
    return similarElements;
  }

  isSimilar(elem1, elem2) {
    // Âü∫Êú¨Â±¨ÊÄßÊØîËºÉ
    if (elem1.tagName !== elem2.tagName) return false;
    if (elem1.className !== elem2.className) return false;
    
    // Â∞∫ÂØ∏ÊØîËºÉ
    const rect1 = elem1.getBoundingClientRect();
    const rect2 = elem2.getBoundingClientRect();
    if (Math.abs(rect1.width - rect2.width) > 10) return false;
    if (Math.abs(rect1.height - rect2.height) > 10) return false;
    
    return true;
  }

  saveRemovalRule(element) {
    const rule = {
      tagName: element.tagName,
      className: element.className,
      id: element.id,
      path: this.getElementPath(element),
      url: window.location.hostname
    };
    
    // ÂÑ≤Â≠òË¶èÂâáÂà∞ chrome.storage
    chrome.storage.local.get(['removalRules'], function(result) {
      const rules = result.removalRules || [];
      rules.push(rule);
      chrome.storage.local.set({ removalRules: rules });
    });
  }

  getElementPath(element) {
    let path = [];
    while (element.parentElement) {
      let selector = element.tagName.toLowerCase();
      if (element.id) {
        selector += '#' + element.id;
      } else if (element.className) {
        selector += '.' + element.className.split(' ').join('.');
      }
      path.unshift(selector);
      element = element.parentElement;
    }
    return path.join(' > ');
  }

  highlightElement(element) {
    if (element === document.body) return;
    
    // ÁßªÈô§‰ªª‰ΩïÁèæÊúâÁöÑÈ´ò‰∫Æ
    element.classList.remove('element-remover-hover');
    element.classList.remove('element-remover-selected');
    element.classList.remove('element-remover-similar');
    
    // Ê†πÊìöÁï∂ÂâçÊ®°ÂºèÊ∑ªÂä†ÈÅ©Áï∂ÁöÑÈ´ò‰∫Æ
    if (this.currentMode === 'similar') {
      element.classList.add('element-remover-similar');
    } else if (this.selectedElements.has(element)) {
      element.classList.add('element-remover-selected');
    } else {
      element.classList.add('element-remover-hover');
    }
  }

  clearHighlight() {
    document.querySelectorAll('.element-remover-hover, .element-remover-similar').forEach(el => {
      el.classList.remove('element-remover-hover', 'element-remover-similar');
    });
  }

  activate() {
    this.isActive = true;
    document.body.style.cursor = 'crosshair';
  }

  deactivate() {
    this.isActive = false;
    document.body.style.cursor = 'default';
    this.clearHighlight();
    this.selectedElements.clear();
  }

  setMode(mode) {
    this.currentMode = mode;
    this.selectedElements.clear();
    this.clearHighlight();
    
    // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
    if (this.floatingMenu) {
      const buttons = this.floatingMenu.querySelectorAll('.mode-btn');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        }
      });
    }
    
    // È°ØÁ§∫Ê®°ÂºèÂàáÊèõÊèêÁ§∫
    let modeText = '';
    switch (mode) {
      case 'single':
        modeText = this.getText('singleMode');
        break;
      case 'multi':
        modeText = this.getText('multiMode');
        // Á´ãÂç≥È°ØÁ§∫Â§öÈÅ∏Ê®°ÂºèÁöÑÊìç‰ΩúÊèêÁ§∫
        setTimeout(() => {
          this.showNotification('notifications.shiftClickTip');
        }, 1000);
        break;
      case 'similar':
        modeText = this.getText('similarMode');
        break;
    }
    this.showNotification('notifications.modeChanged', { mode: modeText });
  }

  updateSettings(settings) {
    this.settings = { ...this.settings, ...settings };
  }

  async toggleMenu() {
    console.log('toggleMenu called');
    
    // Á¢∫‰øùË™ûË®ÄÊ™îÊ°àÂ∑≤ËºâÂÖ•
    if (!this.i18n) {
      console.log('Loading languages first');
      await this.loadLanguages();
    }
    
    if (!this.floatingMenu) {
      console.log('Creating new menu');
      this.floatingMenu = this.createFloatingMenu();
      this.showMenu();
      this.activate();
    } else {
      console.log('Toggling existing menu');
      if (this.isMenuVisible) {
        this.hideMenu();
        this.deactivate();
      } else {
        this.showMenu();
        this.activate();
      }
    }
    
    console.log('Menu visibility:', this.isMenuVisible);
  }

  isValidTarget(element) {
    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Êèí‰ª∂Ëá™Ë∫´ÁöÑÂÖÉÁ¥†
    if (element.closest('.element-remover-menu') || 
        element.closest('.element-remover-notification')) {
      return false;
    }

    // ÊéíÈô§ body Âíå html
    if (element === document.body || element === document.documentElement) {
      return false;
    }

    // Áç≤ÂèñÂÖÉÁ¥†ÁöÑÊ®ôÁ±§ÂêçÁ®±
    const tagName = element.tagName.toLowerCase();

    // ÊéíÈô§ÁâπÂÆöÊ®ôÁ±§
    const excludedTags = ['html', 'body', 'script', 'style', 'link', 'meta', 'head'];
    if (excludedTags.includes(tagName)) {
      return false;
    }

    return true;
  }

  getText(key, params = {}) {
    if (!this.i18n) {
      console.error('Language data not loaded');
      return key;  // ËøîÂõû key ‰ΩúÁÇ∫ÂæåÂÇô
    }

    try {
      const keys = key.split('.');
      let text = this.i18n[this.currentLang];
      
      // Â¶ÇÊûúÁï∂ÂâçË™ûË®Ä‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®Ëã±Êñá
      if (!text) {
        text = this.i18n['en'];
      }
      
      // ÈÅçÊ≠∑ÈçµÂÄºÂèñÂæóÁøªË≠Ø
      for (const k of keys) {
        text = text[k];
        if (!text) {
          console.warn(`Translation not found for key: ${key}`);
          return key;  // ËøîÂõû key ‰ΩúÁÇ∫ÂæåÂÇô
        }
      }
      
      // ÊõøÊèõÂèÉÊï∏
      return text.replace(/\{(\w+)\}/g, (match, key) => params[key] || match);
    } catch (error) {
      console.error('Error getting text:', error);
      return key;  // ËøîÂõû key ‰ΩúÁÇ∫ÂæåÂÇô
    }
  }

  updateMenuText() {
    const menu = document.querySelector('.element-remover-menu');
    if (!menu) return;
    
    menu.querySelector('.element-remover-header').textContent = this.getText('menuTitle');
    menu.querySelector('.mode-section h3').textContent = this.getText('selectMode');
    menu.querySelector('.rules-section h3').textContent = this.getText('rules');
    menu.querySelector('.history-section h3').textContent = this.getText('history');
    
    // Êõ¥Êñ∞ÁµêÊùüÊåâÈàïÊñáÂ≠ó
    const stopButton = menu.querySelector('.stop-btn');
    if (stopButton) {
      stopButton.innerHTML = '‚èπÔ∏è ' + this.getText('stopRemoving');
    }
    
    const modeButtons = menu.querySelectorAll('.mode-btn');
    modeButtons[0].innerHTML = 'üéØ ' + this.getText('singleMode');
    modeButtons[1].innerHTML = '‚ú® ' + this.getText('multiMode');
    modeButtons[2].innerHTML = 'üîç ' + this.getText('similarMode');
    
    const autoHideLabel = menu.querySelector('#autoHide').parentElement;
    autoHideLabel.innerHTML = `
      <input type="checkbox" id="autoHide" ${autoHideLabel.querySelector('input').checked ? 'checked' : ''}>
      ${this.getText('autoHide')}
    `;
    
    const smartSelectLabel = menu.querySelector('#smartSelect').parentElement;
    smartSelectLabel.innerHTML = `
      <input type="checkbox" id="smartSelect" ${smartSelectLabel.querySelector('input').checked ? 'checked' : ''}>
      ${this.getText('smartSelect')}
    `;
    
    const historyButtons = menu.querySelectorAll('.history-actions button');
    historyButtons[0].innerHTML = '‚Ü©Ô∏è ' + this.getText('undo');
    historyButtons[1].innerHTML = '‚Ü™Ô∏è ' + this.getText('redo');
    historyButtons[2].innerHTML = 'üóëÔ∏è ' + this.getText('clear');
  }
}

// ÂàùÂßãÂåñ
const elementManager = new ElementManager();
elementManager.init();

// Áõ£ËÅΩ‰æÜËá™ background ÁöÑÊ∂àÊÅØ
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  console.log('Received message:', request);  // Ê∑ªÂä†Êó•Ë™å
  
  try {
    switch (request.action) {
      case 'toggleSelector':
        console.log('Toggling selector');  // Ê∑ªÂä†Êó•Ë™å
        elementManager.toggleMenu();
        sendResponse({ success: true });
        break;
      case 'setMode':
        elementManager.setMode(request.mode);
        sendResponse({ success: true });
        break;
      case 'undo':
        elementManager.undo();
        sendResponse({ success: true });
        break;
      case 'redo':
        elementManager.redo();
        sendResponse({ success: true });
        break;
      default:
        console.log('Unknown action:', request.action);  // Ê∑ªÂä†Êó•Ë™å
        sendResponse({ success: false, error: 'Unknown action' });
    }
  } catch (error) {
    console.error('Error handling message:', error);  // Ê∑ªÂä†ÈåØË™§Êó•Ë™å
    sendResponse({ success: false, error: error.message });
  }
  
  return true;  // ‰øùÊåÅÊ∂àÊÅØÈÄöÈÅìÈñãÂïü
}); 